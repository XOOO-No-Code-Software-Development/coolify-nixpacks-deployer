# XOOO Backend Deployment Configuration
# Uses pre-built base image with Python, dependencies, and PostgREST

# Keep Python provider so nixpacks can detect the app type
providers = ["python"]

# Use our custom base image with everything pre-installed
buildImage = "xooo-backend-base:latest"

[phases.setup]
# Base image already has everything - skip ALL setup operations
# This prevents nixpacks from running apt-get update and downloading package lists
nixPkgs = []
nixLibs = []
aptPkgs = []
# Add a noop command to prevent provider defaults from being added
cmds = ["echo 'Using pre-built base image, skipping setup'"]

[phases.install]
cmds = [
  # Download source code from v0 API
  "bash download-source.sh",
  
  # Install dependencies from requirements.txt
  # pip will be smart: already installed packages are skipped, new ones are installed
  # This maintains full flexibility for new dependencies while being fast for existing ones
  ". /opt/venv/bin/activate && if [ -f requirements.txt ]; then pip install -r requirements.txt; fi",
  
  # Validate the application
  ". /opt/venv/bin/activate && python -c 'import main; app = main.app; print(\"âœ… Application validation successful\")'",
]