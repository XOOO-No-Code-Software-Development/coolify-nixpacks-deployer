# XOOO Backend Deployment Configuration
# Uses pre-built base image with Python, dependencies, and PostgREST

# Keep Python provider so nixpacks can detect the app type
providers = ["python"]

# Use our custom base image with everything pre-installed
buildImage = "xooo-backend-base:latest"

[phases.setup]
# Base image already has all nix packages and system tools
# Skip ALL setup to avoid re-downloading
nixPkgs = []
nixLibs = []
aptPkgs = []

[phases.install]
cmds = [
  # Download source code from v0 API
  "bash download-source.sh",
  
  # Install any NEW dependencies not in base image (if requirements.txt changed)
  # This will be very fast since most deps are already installed
  ". /opt/venv/bin/activate && if [ -f requirements.txt ]; then pip install --no-deps -r requirements.txt 2>/dev/null || true; fi",
  
  # Validate the application
  ". /opt/venv/bin/activate && python -c 'import main; app = main.app; print(\"âœ… Application validation successful\")'",
]