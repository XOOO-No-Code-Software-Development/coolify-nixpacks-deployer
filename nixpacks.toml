# XOOO Full-Stack Deployment Configuration
# Uses pre-built base image with Python, Node.js, and PostgREST

# Keep Python provider so nixpacks can detect the app type
providers = ["python"]

# Use our custom base image with everything pre-installed
buildImage = "xooo-backend-base:latest"

[phases.setup]
# Install Node.js and npm for Next.js frontend
nixPkgs = ["nodejs_20", "npm-9_x"]
nixLibs = []
aptPkgs = []
cmds = [
  "echo 'Installing Node.js for Next.js frontend...'",
  "node --version",
  "npm --version"
]

[phases.install]
cmds = [
  # Download source code from Vercel API or use empty_template
  "bash download-source.sh",
  
  # Install Next.js dependencies if package.json exists
  "if [ -f package.json ]; then echo 'ðŸ“¦ Installing Next.js dependencies...' && npm install; fi",
  
  # Install Python dependencies if requirements.txt exists
  ". /opt/venv/bin/activate && if [ -f backend/requirements.txt ]; then echo 'ðŸ“¦ Installing Python dependencies...' && pip install -r backend/requirements.txt; fi",
]

[phases.build]
cmds = [
  # Build Next.js if package.json exists
  "if [ -f package.json ]; then echo 'ðŸ”¨ Building Next.js app...' && npm run build; fi",
]